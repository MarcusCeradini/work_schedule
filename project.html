<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Schedule by Hour Ranges</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      max-width: 700px;
      margin: auto;
      padding: 10px;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
      user-select: none;
    }
    .day {
      border: 1px solid #ccc;
      padding: 12px 8px;
      min-height: 90px;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      background-color: #fefefe;
      transition: background-color 0.3s;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    .day:hover {
      background-color: #e6f7ff;
    }
    .day.full {
      background-color: #ffd6d6;
      cursor: not-allowed;
    }
    .day .date-number {
      font-weight: bold;
      font-size: 1.3em;
      margin-bottom: 6px;
      user-select: none;
    }
    .signup-count {
      margin-top: 8px;
      font-size: 0.9em;
      color: #444;
    }
    .header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 18px;
      font-size: 1.1em;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #007bff;
      background: #007bff;
      color: white;
      transition: background-color 0.3s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    #monthYear {
      margin: 0 12px;
      font-size: 1.8em;
      user-select: none;
      white-space: nowrap;
    }
    /* Modal styles */
    #modal {
      display: none; /* hidden by default */
      position: fixed;
      top: 0; left: 0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      padding: 10px;
      z-index: 9999;
      -webkit-overflow-scrolling: touch;
    }
    #modalContent {
      background: white;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
      text-align: left;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-size: 16px;
    }
    #modalContent h3 {
      margin-top: 0;
      font-size: 1.4em;
      user-select: none;
    }
    .signup-entry {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 1em;
      background: #f0f8ff;
      word-break: break-word;
    }
    .signup-entry .time {
      font-weight: bold;
      margin-right: 10px;
    }
    form {
      margin-top: 15px;
      border-top: 1px solid #ccc;
      padding-top: 12px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 1em;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 14px;
      box-sizing: border-box;
      font-size: 1em;
      border: 1.5px solid #ccc;
      border-radius: 6px;
      outline-offset: 2px;
      -webkit-appearance: none;
      appearance: none;
    }
    #closeModalBtn {
      position: absolute;
      top: 10px;
      right: 14px;
      background: #eee;
      border: none;
      font-size: 1.8em;
      cursor: pointer;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      line-height: 34px;
      text-align: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background-color 0.2s;
    }
    #closeModalBtn:hover {
      background: #ccc;
    }
    .error {
      color: red;
      font-size: 0.95em;
      margin-bottom: 10px;
      min-height: 1.2em;
    }

    /* Responsive tweaks */
    @media (max-width: 600px) {
      .calendar {
        grid-template-columns: repeat(4, 1fr);
      }
      button {
        padding: 10px 14px;
        font-size: 1em;
      }
      #monthYear {
        font-size: 1.3em;
      }
      .day {
        min-height: 70px;
        font-size: 13px;
        padding: 10px 6px;
      }
    }
  </style>
</head>
<body>

  <h1>Schedule by Hour Ranges</h1>
  <div class="header">
    <button onclick="changeMonth(-1)" aria-label="Previous Month">&#8592; Prev</button>
    <h2 id="monthYear" aria-live="polite"></h2>
    <button onclick="changeMonth(1)" aria-label="Next Month">Next &#8594;</button>
  </div>

  <div class="calendar" id="calendar" role="list" aria-label="Calendar days"></div>

  <!-- Modal for signups -->
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalDateTitle" tabindex="-1">
    <div id="modalContent">
      <button id="closeModalBtn" title="Close">&times;</button>
      <h3 id="modalDateTitle"></h3>
      <div id="signupsList" tabindex="0" aria-live="polite">
        <!-- existing signups shown here -->
      </div>

      <form id="signupForm">
        <div class="error" id="errorMsg" aria-live="assertive"></div>
        <label for="nameInput">Your Name:</label>
        <input type="text" id="nameInput" required placeholder="Enter your name" autocomplete="name" />

        <label for="startHourSelect">Start Hour:</label>
        <select id="startHourSelect" required aria-describedby="startHourDesc"></select>

        <label for="endHourSelect">End Hour:</label>
        <select id="endHourSelect" required aria-describedby="endHourDesc"></select>

        <button type="submit">Sign Up</button>
      </form>
    </div>
  </div>

<script>
  const MAX_PEOPLE_AT_ONCE = 3; // max people allowed working simultaneously
  const DAILY_START = "09:00";
  const DAILY_END = "18:00";

  let currentDate = new Date();

  // signups format:
  // { 'YYYY-MM-DD': [ { name, startTime, endTime }, ... ] }
  let signups = {};

  // Load signups from backend API
  async function loadSignups() {
    try {
      const res = await fetch('/api/signups');
      if (!res.ok) throw new Error('Failed to fetch signups');
      signups = await res.json();
    } catch (e) {
      signups = {};
      console.error(e);
    }
  }

  // Save a single new signup to backend API
  async function saveSignup(dateStr, entry) {
    try {
      const res = await fetch('/api/signups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date: dateStr, entry })
      });
      if (!res.ok) throw new Error('Failed to save signup');
    } catch (e) {
      console.error(e);
    }
  }

  function renderCalendar() {
    const calendar = document.getElementById('calendar');
    const monthYear = document.getElementById('monthYear');
    calendar.innerHTML = '';

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay(); // Sunday = 0

    monthYear.textContent = `${firstDay.toLocaleString('default', { month: 'long' })} ${year}`;

    // Fill empty cells for first week day offset
    for (let i = 0; i < startDay; i++) {
      const empty = document.createElement('div');
      calendar.appendChild(empty);
    }

    const today = new Date();
    today.setHours(0,0,0,0); // clear time for date comparison

    for (let day = 1; day <= lastDay.getDate(); day++) {
      const dateStr = formatDate(year, month + 1, day);
      const dayDate = new Date(year, month, day);
      dayDate.setHours(0,0,0,0);

      const dayDiv = document.createElement('div');
      dayDiv.classList.add('day');
      dayDiv.setAttribute('role', 'listitem');
      dayDiv.setAttribute('tabindex', '-1');

      const totalSignups = (signups[dateStr] || []).length;

      dayDiv.innerHTML = `<div class="date-number">${day}</div>
                          <div class="signup-count">${totalSignups} signed up</div>`;

      // Disable past days (not clickable)
      if (dayDate < today) {
        dayDiv.style.backgroundColor = '#f0f0f0';
        dayDiv.style.color = '#999';
        dayDiv.style.cursor = 'not-allowed';
        dayDiv.setAttribute('aria-disabled', 'true');
      } else {
        dayDiv.onclick = () => openModal(dateStr);
        dayDiv.setAttribute('tabindex', '0');
        dayDiv.setAttribute('aria-label', `Day ${day}, ${totalSignups} people signed up. Tap to sign up.`);
        dayDiv.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openModal(dateStr);
          }
        });
      }

      calendar.appendChild(dayDiv);
    }
  }

  function openModal(dateStr) {
    const modal = document.getElementById('modal');
    const modalDateTitle = document.getElementById('modalDateTitle');
    const signupsList = document.getElementById('signupsList');
    const signupForm = document.getElementById('signupForm');
    const errorMsg = document.getElementById('errorMsg');
    const nameInput = document.getElementById('nameInput');
    const startHourSelect = document.getElementById('startHourSelect');
    const endHourSelect = document.getElementById('endHourSelect');

    modalDateTitle.textContent = `Signups for ${dateStr}`;
    errorMsg.textContent = '';
    nameInput.value = '';
    startHourSelect.value = '';
    endHourSelect.value = '';

    // Populate existing signups
    const entries = signups[dateStr] || [];
    signupsList.innerHTML = '';
    if (entries.length === 0) {
      signupsList.textContent = "No signups yet.";
    } else {
      entries.forEach(({name, startTime, endTime}) => {
        const div = document.createElement('div');
        div.className = 'signup-entry';
        div.textContent = `${startTime} - ${endTime} : ${name}`;
        signupsList.appendChild(div);
      });
    }

    // Populate time dropdowns
    fillTimeOptions(startHourSelect, DAILY_START, DAILY_END);
    fillTimeOptions(endHourSelect, DAILY_START, DAILY_END);

    // Set minimal default for end hour select (at least one hour after start)
    startHourSelect.onchange = () => {
      const startVal = startHourSelect.value;
      if (startVal) {
        const startHour = parseInt(startVal.split(':')[0]);
        // Set end select options to start from startHour + 1
        fillTimeOptions(endHourSelect, addHour(startVal, 1), DAILY_END);
      }
    };

    // Show modal
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    // Focus on name input
    nameInput.focus();
  }

  function closeModal() {
    const modal = document.getElementById('modal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }

  // Utility to fill select with hour options like "09:00", "10:00", ...
  function fillTimeOptions(selectElem, startStr, endStr) {
    selectElem.innerHTML = '';
    const startHour = parseInt(startStr.split(':')[0]);
    const endHour = parseInt(endStr.split(':')[0]);
    for (let h = startHour; h <= endHour; h++) {
      let hourStr = h.toString().padStart(2, '0') + ':00';
      const option = document.createElement('option');
      option.value = hourStr;
      option.textContent = hourStr;
      selectElem.appendChild(option);
    }
  }

  // Adds hours to HH:MM string
  function addHour(timeStr, add) {
    let h = parseInt(timeStr.split(':')[0], 10);
    let m = parseInt(timeStr.split(':')[1], 10);
    h += add;
    if (h > 23) h = 23;
    return h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0');
  }

  // Format date to YYYY-MM-DD
  function formatDate(year, month, day) {
    return `${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
  }

  // Count how many people overlap given time range
  function countOverlap(entries, startTime, endTime) {
    let count = 0;
    entries.forEach(({startTime: s, endTime: e}) => {
      if (timesOverlap(s, e, startTime, endTime)) count++;
    });
    return count;
  }

  // Check if two time ranges overlap (inclusive start, exclusive end)
  function timesOverlap(s1, e1, s2, e2) {
    return !(e1 <= s2 || e2 <= s1);
  }

  // Handle month change buttons
  function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar();
  }

  // Setup form submission handler
  document.getElementById('signupForm').onsubmit = async function (e) {
    e.preventDefault();
    const errorMsg = document.getElementById('errorMsg');
    errorMsg.textContent = '';

    const name = document.getElementById('nameInput').value.trim();
    const startTime = document.getElementById('startHourSelect').value;
    const endTime = document.getElementById('endHourSelect').value;

    if (!name || !startTime || !endTime) {
      errorMsg.textContent = "Please fill out all fields.";
      return;
    }
    if (parseInt(endTime.split(':')[0]) <= parseInt(startTime.split(':')[0])) {
      errorMsg.textContent = "End hour must be after start hour.";
      return;
    }

    // Get date from modal title: "Signups for YYYY-MM-DD"
    const modalDateTitle = document.getElementById('modalDateTitle').textContent;
    const dateStr = modalDateTitle.replace('Signups for ', '');

    if (!signups[dateStr]) signups[dateStr] = [];

    // Check max overlap
    const overlappingCount = countOverlap(signups[dateStr], startTime, endTime);
    if (overlappingCount >= MAX_PEOPLE_AT_ONCE) {
      errorMsg.textContent = "Too many people already scheduled during this time range.";
      return;
    }

    // Check user overlap
    const userConflict = signups[dateStr].some(entry => entry.name.toLowerCase() === name.toLowerCase() &&
      timesOverlap(entry.startTime, entry.endTime, startTime, endTime));
    if (userConflict) {
      errorMsg.textContent = "You already have a signup overlapping this time.";
      return;
    }

    const newEntry = { name, startTime, endTime };
    signups[dateStr].push(newEntry);

    await saveSignup(dateStr, newEntry);
    await loadSignups();

    openModal(dateStr);
    renderCalendar();
  };

  // Modal close button
  document.getElementById('closeModalBtn').onclick = closeModal;
  // Close modal on outside click
  document.getElementById('modal').onclick = (e) => {
    if (e.target === e.currentTarget) closeModal();
  };
  // Close modal on Escape key
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('modal').style.display === 'flex') {
      closeModal();
    }
  });

  // Initial load
  (async () => {
    await loadSignups();
    renderCalendar();
  })();
</script>

</body>
</html>
