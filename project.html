<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Schedule by Hour Ranges (Firebase)</title>
  <style>
    /* Your original styles here */
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      max-width: 700px;
      margin: auto;
      padding: 10px;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
      user-select: none;
    }
    .day {
      border: 1px solid #ccc;
      padding: 12px 8px;
      min-height: 90px;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      background-color: #fefefe;
      transition: background-color 0.3s;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    .day:hover {
      background-color: #e6f7ff;
    }
    .day.full {
      background-color: #ffd6d6;
      cursor: not-allowed;
    }
    .day .date-number {
      font-weight: bold;
      font-size: 1.3em;
      margin-bottom: 6px;
      user-select: none;
    }
    .signup-count {
      margin-top: 8px;
      font-size: 0.9em;
      color: #444;
    }
    .header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 18px;
      font-size: 1.1em;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #007bff;
      background: #007bff;
      color: white;
      transition: background-color 0.3s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    #monthYear {
      margin: 0 12px;
      font-size: 1.8em;
      user-select: none;
      white-space: nowrap;
    }
    /* Modal styles */
    #modal {
      display: none; /* hidden by default */
      position: fixed;
      top: 0; left: 0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      padding: 10px;
      z-index: 9999;
      -webkit-overflow-scrolling: touch;
    }
    #modalContent {
      background: white;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
      text-align: left;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-size: 16px;
    }
    #modalContent h3 {
      margin-top: 0;
      font-size: 1.4em;
      user-select: none;
    }
    .signup-entry {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 1em;
      background: #f0f8ff;
      word-break: break-word;
    }
    .signup-entry .time {
      font-weight: bold;
      margin-right: 10px;
    }
    form {
      margin-top: 15px;
      border-top: 1px solid #ccc;
      padding-top: 12px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 1em;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 14px;
      box-sizing: border-box;
      font-size: 1em;
      border: 1.5px solid #ccc;
      border-radius: 6px;
      outline-offset: 2px;
      -webkit-appearance: none;
      appearance: none;
    }
    #closeModalBtn {
      position: absolute;
      top: 10px;
      right: 14px;
      background: #eee;
      border: none;
      font-size: 1.8em;
      cursor: pointer;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      line-height: 34px;
      text-align: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background-color 0.2s;
    }
    #closeModalBtn:hover {
      background: #ccc;
    }
    .error {
      color: red;
      font-size: 0.95em;
      margin-bottom: 10px;
      min-height: 1.2em;
    }

    /* Responsive tweaks */
    @media (max-width: 600px) {
      .calendar {
        grid-template-columns: repeat(4, 1fr);
      }
      button {
        padding: 10px 14px;
        font-size: 1em;
      }
      #monthYear {
        font-size: 1.3em;
      }
      .day {
        min-height: 70px;
        font-size: 13px;
        padding: 10px 6px;
      }
    }
  </style>
</head>
<body>

  <h1>Schedule by Hour Ranges (Firebase)</h1>
  <div class="header">
    <button onclick="changeMonth(-1)" aria-label="Previous Month">&#8592; Prev</button>
    <h2 id="monthYear" aria-live="polite"></h2>
    <button onclick="changeMonth(1)" aria-label="Next Month">Next &#8594;</button>
  </div>

  <div class="calendar" id="calendar" role="list" aria-label="Calendar days"></div>

  <!-- Modal for signups -->
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalDateTitle" tabindex="-1">
    <div id="modalContent">
      <button id="closeModalBtn" title="Close">&times;</button>
      <h3 id="modalDateTitle"></h3>
      <div id="signupsList" tabindex="0" aria-live="polite">
        <!-- existing signups shown here -->
      </div>

      <form id="signupForm">
        <div class="error" id="errorMsg" aria-live="assertive"></div>
        <label for="nameInput">Your Name:</label>
        <input type="text" id="nameInput" required placeholder="Enter your name" autocomplete="name" />

        <label for="startHourSelect">Start Hour:</label>
        <select id="startHourSelect" required aria-describedby="startHourDesc"></select>

        <label for="endHourSelect">End Hour:</label>
        <select id="endHourSelect" required aria-describedby="endHourDesc"></select>

        <button type="submit">Sign Up</button>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Your Firebase config here â€” REPLACE WITH YOUR OWN from Firebase Console!
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Constants
    const MAX_PEOPLE_AT_ONCE = 3; // max people allowed working simultaneously
    const DAILY_START = "09:00";
    const DAILY_END = "18:00";

    let currentDate = new Date();

    // signups format:
    // { 'YYYY-MM-DD': [ { name, startTime, endTime }, ... ] }
    let signups = {};

    // Save signups to Firebase
    function saveSignupsToFirebase() {
      db.ref('signups').set(signups)
        .then(() => console.log('Signups saved successfully!'))
        .catch(error => console.error('Failed to save signups:', error));
    }

    // Load signups from Firebase & render calendar
    function loadSignupsFromFirebase() {
      db.ref('signups').on('value', (snapshot) => {
        signups = snapshot.val() || {};
        console.log('Loaded signups:', signups);
        renderCalendar();
      }, (error) => {
        console.error('Failed to load signups:', error);
      });
    }

    function renderCalendar() {
      const calendar = document.getElementById('calendar');
      const monthYear = document.getElementById('monthYear');
      calendar.innerHTML = '';

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay(); // Sunday = 0

      monthYear.textContent = `${firstDay.toLocaleString('default', { month: 'long' })} ${year}`;

      // Fill empty cells for first week day offset
      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement('div');
        calendar.appendChild(empty);
      }

      const today = new Date();
      today.setHours(0,0,0,0); // clear time for date comparison

      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = formatDate(year, month + 1, day);
        const dayDate = new Date(year, month, day);
        dayDate.setHours(0,0,0,0);

        const dayDiv = document.createElement('div');
        dayDiv.classList.add('day');
        dayDiv.setAttribute('role', 'listitem');
        dayDiv.setAttribute('tabindex', '0');
        dayDiv.setAttribute('aria-label', `${dateStr}, click to view or sign up`);
        dayDiv.dataset.date = dateStr;

        // Show date number
        const dateNumber = document.createElement('div');
        dateNumber.classList.add('date-number');
        dateNumber.textContent = day;
        dayDiv.appendChild(dateNumber);

        // Show number of signups on that day
        const daySignups = signups[dateStr] || [];
        const countSpan = document.createElement('div');
        countSpan.classList.add('signup-count');
        countSpan.textContent = `${daySignups.length} signup${daySignups.length !== 1 ? 's' : ''}`;
        dayDiv.appendChild(countSpan);

        // Check if day is fully booked (max people reached for all hours 9-18)
        if (isDayFull(daySignups)) {
          dayDiv.classList.add('full');
          dayDiv.setAttribute('aria-disabled', 'true');
        }

        // Clicking or pressing Enter/Space opens modal for that day
        dayDiv.addEventListener('click', () => openModal(dateStr));
        dayDiv.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openModal(dateStr);
          }
        });

        calendar.appendChild(dayDiv);
      }
    }

    function isDayFull(daySignups) {
      // Check for each hour if max people are signed up
      for (let hour = 9; hour < 18; hour++) {
        const peopleAtHour = daySignups.filter(su =>
          isHourInRange(hour, su.startTime, su.endTime)
        ).length;
        if (peopleAtHour < MAX_PEOPLE_AT_ONCE) {
          return false; // at least one hour has space
        }
      }
      return true; // all hours full
    }

    function isHourInRange(hour, startTime, endTime) {
      // startTime and endTime like "09:00"
      const [startH, startM] = startTime.split(':').map(Number);
      const [endH, endM] = endTime.split(':').map(Number);
      const startVal = startH + startM / 60;
      const endVal = endH + endM / 60;
      return hour >= startVal && hour < endVal;
    }

    // Modal and form handling
    const modal = document.getElementById('modal');
    const modalDateTitle = document.getElementById('modalDateTitle');
    const signupsList = document.getElementById('signupsList');
    const signupForm = document.getElementById('signupForm');
    const errorMsg = document.getElementById('errorMsg');
    const nameInput = document.getElementById('nameInput');
    const startHourSelect = document.getElementById('startHourSelect');
    const endHourSelect = document.getElementById('endHourSelect');
    const closeModalBtn = document.getElementById('closeModalBtn');

    let selectedDate = null;

    // Populate start and end hour selects with options (9am to 6pm)
    function populateTimeSelects() {
      startHourSelect.innerHTML = '';
      endHourSelect.innerHTML = '';

      for (let hour = 9; hour <= 17; hour++) {
        const timeStr = formatHour(hour);
        const option = document.createElement('option');
        option.value = timeStr;
        option.textContent = timeStr;
        startHourSelect.appendChild(option);
      }

      for (let hour = 10; hour <= 18; hour++) {
        const timeStr = formatHour(hour);
        const option = document.createElement('option');
        option.value = timeStr;
        option.textContent = timeStr;
        endHourSelect.appendChild(option);
      }
    }

    // When start hour changes, adjust end hour options minimum
    startHourSelect.addEventListener('change', () => {
      const startVal = parseInt(startHourSelect.value.split(':')[0]);
      Array.from(endHourSelect.options).forEach(option => {
        const endVal = parseInt(option.value.split(':')[0]);
        option.disabled = endVal <= startVal;
      });

      // If current end hour is invalid, set to next hour after start
      if (parseInt(endHourSelect.value.split(':')[0]) <= startVal) {
        const nextHour = startVal + 1;
        const nextVal = formatHour(nextHour);
        endHourSelect.value = nextVal;
      }
    });

    // Open modal for given date string "YYYY-MM-DD"
    function openModal(dateStr) {
      selectedDate = dateStr;
      modalDateTitle.textContent = new Date(dateStr).toDateString();
      errorMsg.textContent = '';
      signupForm.reset();
      populateTimeSelects();

      renderSignupsList(dateStr);

      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      modal.focus();

      // Trap focus inside modal for accessibility
      trapFocus(modal);
    }

    // Close modal
    function closeModal() {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      selectedDate = null;
    }

    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal(); // click outside modal content closes it
    });

    // Render signups for a day inside modal
    function renderSignupsList(dateStr) {
      signupsList.innerHTML = '';

      const daySignups = signups[dateStr] || [];
      if (daySignups.length === 0) {
        signupsList.textContent = 'No signups yet.';
        return;
      }

      daySignups.forEach(su => {
        const div = document.createElement('div');
        div.classList.add('signup-entry');
        div.innerHTML = `<span class="time">${su.startTime} - ${su.endTime}</span> <span class="name">${escapeHtml(su.name)}</span>`;
        signupsList.appendChild(div);
      });
    }

    // Escape user input to prevent HTML injection
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Format date as "YYYY-MM-DD"
    function formatDate(y, m, d) {
      return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    }

    // Format hour like "09:00"
    function formatHour(h) {
      return `${String(h).padStart(2, '0')}:00`;
    }

    // Add signup if valid
    function addSignup(dateStr, signup) {
      if (!signups[dateStr]) signups[dateStr] = [];
      signups[dateStr].push(signup);
    }

    // Check if signup overlaps and respects max people
    function canAddSignup(dateStr, newSignup) {
      const daySignups = signups[dateStr] || [];
      const newStart = parseTime(newSignup.startTime);
      const newEnd = parseTime(newSignup.endTime);

      for (let hour = 9; hour < 18; hour++) {
        const hourTime = hour * 60;
        // Count how many people are signed up during this hour
        const count = daySignups.filter(su => {
          const suStart = parseTime(su.startTime);
          const suEnd = parseTime(su.endTime);
          // overlap if hour overlaps with signup interval
          return intervalsOverlap(hourTime, hourTime + 60, suStart, suEnd);
        }).length;

        // Check if new signup overlaps this hour
        if (intervalsOverlap(hourTime, hourTime + 60, newStart, newEnd)) {
          if (count >= MAX_PEOPLE_AT_ONCE) {
            return false;
          }
        }
      }
      return true;
    }

    // Parse "HH:MM" to minutes since midnight
    function parseTime(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    }

    // Check if two intervals [start1, end1) and [start2, end2) overlap
    function intervalsOverlap(start1, end1, start2, end2) {
      return start1 < end2 && start2 < end1;
    }

    // Handle form submission
    signupForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const name = nameInput.value.trim();
      const startTime = startHourSelect.value;
      const endTime = endHourSelect.value;

      if (!name) {
        errorMsg.textContent = 'Please enter your name.';
        return;
      }

      if (startTime >= endTime) {
        errorMsg.textContent = 'Start time must be before end time.';
        return;
      }

      const newSignup = { name, startTime, endTime };

      if (!canAddSignup(selectedDate, newSignup)) {
        errorMsg.textContent = 'Sorry, the selected time slot is fully booked.';
        return;
      }

      // Add signup & save to Firebase
      addSignup(selectedDate, newSignup);
      saveSignupsToFirebase();

      // Update UI
      renderSignupsList(selectedDate);
      renderCalendar();

      // Clear form and error
      signupForm.reset();
      errorMsg.textContent = '';

      alert('Signed up successfully!');

      // Close modal after success
      closeModal();
    });

    // Month navigation
    function changeMonth(delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      renderCalendar();
    }

    // Trap focus inside modal for accessibility
    function trapFocus(element) {
      const focusableSelectors = 'a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])';
      const focusableElements = Array.from(element.querySelectorAll(focusableSelectors))
        .filter(el => !el.hasAttribute('disabled') && el.offsetParent !== null);

      if (focusableElements.length === 0) return;

      let firstEl = focusableElements[0];
      let lastEl = focusableElements[focusableElements.length - 1];

      element.addEventListener('keydown', function trap(e) {
        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstEl) {
              e.preventDefault();
              lastEl.focus();
            }
          } else {
            if (document.activeElement === lastEl) {
              e.preventDefault();
              firstEl.focus();
            }
          }
        }
      });
      // Focus first element initially
      firstEl.focus();
    }

    // Initial load
    loadSignupsFromFirebase();
    renderCalendar();

  </script>
</body>
</html>
