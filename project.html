<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Schedule by Hour Ranges (Firebase)</title>
  <style>
    /* Your original styles here */
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      max-width: 700px;
      margin: auto;
      padding: 10px;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
      user-select: none;
    }
    .day {
      border: 1px solid #ccc;
      padding: 12px 8px;
      min-height: 90px;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      background-color: #fefefe;
      transition: background-color 0.3s;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    .day:hover {
      background-color: #e6f7ff;
    }
    .day.full {
      background-color: #ffd6d6;
      cursor: not-allowed;
    }
    .day .date-number {
      font-weight: bold;
      font-size: 1.3em;
      margin-bottom: 6px;
      user-select: none;
    }
    .signup-count {
      margin-top: 8px;
      font-size: 0.9em;
      color: #444;
    }
    .header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 18px;
      font-size: 1.1em;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #007bff;
      background: #007bff;
      color: white;
      transition: background-color 0.3s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    #monthYear {
      margin: 0 12px;
      font-size: 1.8em;
      user-select: none;
      white-space: nowrap;
    }
    /* Modal styles */
    #modal {
      display: none; /* hidden by default */
      position: fixed;
      top: 0; left: 0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      padding: 10px;
      z-index: 9999;
      -webkit-overflow-scrolling: touch;
    }
    #modalContent {
      background: white;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
      text-align: left;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-size: 16px;
    }
    #modalContent h3 {
      margin-top: 0;
      font-size: 1.4em;
      user-select: none;
    }
    .signup-entry {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 1em;
      background: #f0f8ff;
      word-break: break-word;
    }
    .signup-entry .time {
      font-weight: bold;
      margin-right: 10px;
    }
    form {
      margin-top: 15px;
      border-top: 1px solid #ccc;
      padding-top: 12px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 1em;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 14px;
      box-sizing: border-box;
      font-size: 1em;
      border: 1.5px solid #ccc;
      border-radius: 6px;
      outline-offset: 2px;
      -webkit-appearance: none;
      appearance: none;
    }
    #closeModalBtn {
      position: absolute;
      top: 10px;
      right: 14px;
      background: #eee;
      border: none;
      font-size: 1.8em;
      cursor: pointer;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      line-height: 34px;
      text-align: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background-color 0.2s;
    }
    #closeModalBtn:hover {
      background: #ccc;
    }
    .error {
      color: red;
      font-size: 0.95em;
      margin-bottom: 10px;
      min-height: 1.2em;
    }

    /* Responsive tweaks */
    @media (max-width: 600px) {
      .calendar {
        grid-template-columns: repeat(4, 1fr);
      }
      button {
        padding: 10px 14px;
        font-size: 1em;
      }
      #monthYear {
        font-size: 1.3em;
      }
      .day {
        min-height: 70px;
        font-size: 13px;
        padding: 10px 6px;
      }
    }
  </style>
</head>
<body>

  <h1>Schedule by Hour Ranges (Firebase)</h1>
  <div class="header">
    <button onclick="changeMonth(-1)" aria-label="Previous Month">&#8592; Prev</button>
    <h2 id="monthYear" aria-live="polite"></h2>
    <button onclick="changeMonth(1)" aria-label="Next Month">Next &#8594;</button>
  </div>

  <div class="calendar" id="calendar" role="list" aria-label="Calendar days"></div>

  <!-- Modal for signups -->
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalDateTitle" tabindex="-1">
    <div id="modalContent">
      <button id="closeModalBtn" title="Close">&times;</button>
      <h3 id="modalDateTitle"></h3>
      <div id="signupsList" tabindex="0" aria-live="polite">
        <!-- existing signups shown here -->
      </div>

      <form id="signupForm">
        <div class="error" id="errorMsg" aria-live="assertive"></div>
        <label for="nameInput">Your Name:</label>
        <input type="text" id="nameInput" required placeholder="Enter your name" autocomplete="name" />

        <label for="startHourSelect">Start Hour:</label>
        <select id="startHourSelect" required aria-describedby="startHourDesc"></select>

        <label for="endHourSelect">End Hour:</label>
        <select id="endHourSelect" required aria-describedby="endHourDesc"></select>

        <button type="submit">Sign Up</button>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "firebase/app";
    import { getAnalytics } from "firebase/analytics";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyC93r-r-kHNFqu1A2KjqSGMBbx44CTwP2w",
      authDomain: "project-for-work-aa517.firebaseapp.com",
      databaseURL: "https://project-for-work-aa517-default-rtdb.firebaseio.com",
      projectId: "project-for-work-aa517",
      storageBucket: "project-for-work-aa517.firebasestorage.app",
      messagingSenderId: "51216544368",
      appId: "1:51216544368:web:92f67608efdef977207ab5",
      measurementId: "G-H9QVKED2J5"
    };

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);


    const MAX_PEOPLE_AT_ONCE = 3; // max people allowed working simultaneously

    let currentDate = new Date();

    // signups data structure: will hold data for the currently displayed month
    let signupsData = {};

    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('monthYear');

    // Modal elements
    const modal = document.getElementById('modal');
    const modalDateTitle = document.getElementById('modalDateTitle');
    const signupsList = document.getElementById('signupsList');
    const signupForm = document.getElementById('signupForm');
    const nameInput = document.getElementById('nameInput');
    const startHourSelect = document.getElementById('startHourSelect');
    const endHourSelect = document.getElementById('endHourSelect');
    const errorMsg = document.getElementById('errorMsg');
    const closeModalBtn = document.getElementById('closeModalBtn');

    // To track which date is currently open in modal
    let modalOpenDate = null;

    // Setup hour options
    function setupHourSelects() {
      startHourSelect.innerHTML = '';
      endHourSelect.innerHTML = '';
      for (let h = 0; h <= 23; h++) {
        const opt1 = document.createElement('option');
        opt1.value = h;
        opt1.textContent = `${h}:00`;
        startHourSelect.appendChild(opt1);
        const opt2 = document.createElement('option');
        opt2.value = h;
        opt2.textContent = `${h}:00`;
        endHourSelect.appendChild(opt2);
      }
      startHourSelect.value = '8';
      endHourSelect.value = '12';
    }

    // Utility: Format date as YYYY-MM-DD for keys
    function formatDateKey(date) {
      return date.toISOString().slice(0, 10);
    }

    // Utility: Format date string to more readable format for modal title
    function formatDateDisplay(date) {
      return date.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Change month, then render calendar for that month
    function changeMonth(delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      loadAndRenderCalendar();
    }

    // Load signups from Firebase for current month
    function loadSignupsForMonth(year, month) {
      // We'll query all signups for this month
      // Since data stored under /signups/YYYY-MM-DD/, and keys are dates, 
      // we can read all signups and filter by date prefix, or fetch all then filter
      // To optimize, let's fetch all and then filter by year-month prefix

      return new Promise((resolve, reject) => {
        db.ref('signups').once('value', (snapshot) => {
          const allData = snapshot.val() || {};
          // Filter keys starting with year-month e.g. '2025-08'
          const prefix = `${year.toString().padStart(4, '0')}-${(month+1).toString().padStart(2, '0')}`;
          const filtered = {};
          for (const dateKey in allData) {
            if (dateKey.startsWith(prefix)) {
              filtered[dateKey] = allData[dateKey];
            }
          }
          resolve(filtered);
        }, (error) => {
          reject(error);
        });
      });
    }

    // Listen for realtime updates for current month, re-render calendar when changed
    function setupRealtimeListener(year, month) {
      // Remove old listener if any
      if (setupRealtimeListener.ref) {
        setupRealtimeListener.ref.off();
      }
      // Listen to all signups and filter by month
      const signupsRef = db.ref('signups');
      setupRealtimeListener.ref = signupsRef;

      signupsRef.on('value', (snapshot) => {
        const allData = snapshot.val() || {};
        const prefix = `${year.toString().padStart(4, '0')}-${(month+1).toString().padStart(2, '0')}`;
        const filtered = {};
        for (const dateKey in allData) {
          if (dateKey.startsWith(prefix)) {
            filtered[dateKey] = allData[dateKey];
          }
        }
        signupsData = filtered;
        renderCalendar();
        // If modal open, refresh its content with updated data
        if (modalOpenDate) {
          renderModalContent(modalOpenDate);
        }
      });
    }

    // Render calendar grid for currentDate
    function renderCalendar() {
      calendarEl.innerHTML = '';

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      // Display month-year title
      monthYearEl.textContent = currentDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long' });

      // Find first day of the month (0=Sunday, 1=Monday,...)
      const firstDay = new Date(year, month, 1);
      const startWeekday = firstDay.getDay();

      // Number of days in this month
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Fill blank days for previous month (for Sunday-start calendar)
      for (let i = 0; i < startWeekday; i++) {
        const blankDay = document.createElement('div');
        blankDay.classList.add('day');
        blankDay.style.visibility = 'hidden';
        calendarEl.appendChild(blankDay);
      }

      // Create day cells
      for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('day');
        dayDiv.setAttribute('role', 'listitem');
        dayDiv.tabIndex = 0;

        const dateObj = new Date(year, month, day);
        const dateKey = formatDateKey(dateObj);

        // Date number
        const dateNumber = document.createElement('div');
        dateNumber.textContent = day;
        dateNumber.classList.add('date-number');
        dayDiv.appendChild(dateNumber);

        // Show how many people signed up for that day in total
        let totalSignedUp = 0;
        if (signupsData[dateKey]) {
          // Sum all time ranges signups
          for (const signupId in signupsData[dateKey]) {
            totalSignedUp++;
          }
        }

        // Check if max people reached for any overlapping time ranges
        // This is more complex, but for day display let's just show total count
        // Detailed conflict check done inside modal

        const countEl = document.createElement('div');
        countEl.classList.add('signup-count');
        countEl.textContent = totalSignedUp === 0 ? 'No signups' : `${totalSignedUp} signed up`;
        dayDiv.appendChild(countEl);

        // If fully booked (more than MAX_PEOPLE_AT_ONCE in all ranges combined, just as rough indication)
        if (totalSignedUp >= MAX_PEOPLE_AT_ONCE * 5) { 
          // 5 is an arbitrary threshold since hours vary; you can refine logic here
          dayDiv.classList.add('full');
          dayDiv.title = 'Fully booked';
        }

        // Click or key enter opens modal for that date
        dayDiv.addEventListener('click', () => openModal(dateObj));
        dayDiv.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openModal(dateObj);
          }
        });

        calendarEl.appendChild(dayDiv);
      }
    }

    // Open modal for a specific date
    function openModal(dateObj) {
      modalOpenDate = dateObj;
      modalDateTitle.textContent = formatDateDisplay(dateObj);
      errorMsg.textContent = '';
      nameInput.value = '';
      setupHourSelects();
      renderModalContent(dateObj);
      modal.style.display = 'flex';
      nameInput.focus();
      document.body.style.overflow = 'hidden'; // prevent background scroll
    }

    // Close modal
    function closeModal() {
      modal.style.display = 'none';
      modalOpenDate = null;
      errorMsg.textContent = '';
      document.body.style.overflow = ''; // restore scroll
    }

    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // Escape key closes modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeModal();
      }
    });

    // Render modal content: show existing signups and setup form
    function renderModalContent(dateObj) {
      const dateKey = formatDateKey(dateObj);
      signupsList.innerHTML = '';

      if (signupsData[dateKey]) {
        const daySignups = signupsData[dateKey];

        // Sort signups by startHour
        const sortedSignups = Object.values(daySignups).sort((a, b) => a.startHour - b.startHour);

        if (sortedSignups.length === 0) {
          signupsList.textContent = 'No signups yet for this day.';
        } else {
          sortedSignups.forEach(signup => {
            const div = document.createElement('div');
            div.classList.add('signup-entry');
            div.textContent = `${signup.name} — ${signup.startHour}:00 to ${signup.endHour}:00`;
            signupsList.appendChild(div);
          });
        }
      } else {
        signupsList.textContent = 'No signups yet for this day.';
      }
    }

    // Check if new signup conflicts with max people limit per hour range
    function canSignup(dateKey, newStart, newEnd) {
      // Gather all signups on dateKey
      const daySignups = signupsData[dateKey] || {};

      // We want to check for each hour in [newStart, newEnd), count how many signups overlap
      // If any hour reaches MAX_PEOPLE_AT_ONCE, reject

      // We'll create an array of length 24 to count overlaps per hour
      const hourCounts = new Array(24).fill(0);

      for (const signupId in daySignups) {
        const s = daySignups[signupId];
        for (let h = s.startHour; h < s.endHour; h++) {
          hourCounts[h]++;
        }
      }
      // Check new signup hours
      for (let h = newStart; h < newEnd; h++) {
        if (hourCounts[h] >= MAX_PEOPLE_AT_ONCE) {
          return false;
        }
      }
      return true;
    }

    // Submit signup form
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.textContent = '';

      const name = nameInput.value.trim();
      const startHour = parseInt(startHourSelect.value, 10);
      const endHour = parseInt(endHourSelect.value, 10);

      if (!name) {
        errorMsg.textContent = 'Please enter your name.';
        return;
      }
      if (isNaN(startHour) || isNaN(endHour)) {
        errorMsg.textContent = 'Please select valid start and end hours.';
        return;
      }
      if (startHour >= endHour) {
        errorMsg.textContent = 'Start hour must be before end hour.';
        return;
      }

      const dateKey = formatDateKey(modalOpenDate);

      // Check for conflicts with existing signups
      if (!canSignup(dateKey, startHour, endHour)) {
        errorMsg.textContent = 'Sorry, that time range is fully booked. Please choose another time.';
        return;
      }

      // Save to Firebase under /signups/YYYY-MM-DD/ with a new push key
      try {
        await db.ref(`signups/${dateKey}`).push({
          name,
          startHour,
          endHour
        });

        // Success - clear form, update UI (Firebase realtime listener will update signupsData and rerender)
        nameInput.value = '';
        setupHourSelects();
        errorMsg.textContent = 'Signup successful!';
        nameInput.focus();
      } catch (error) {
        errorMsg.textContent = 'Error saving signup. Please try again.';
        console.error('Firebase write error:', error);
      }
    });

    // Validate end hour select dynamically (end hour > start hour)
    startHourSelect.addEventListener('change', () => {
      const startVal = parseInt(startHourSelect.value, 10);
      updateEndHourOptions(startVal);
    });

    function updateEndHourOptions(minStart) {
      for (let i = 0; i < endHourSelect.options.length; i++) {
        const option = endHourSelect.options[i];
        option.disabled = parseInt(option.value, 10) <= minStart;
      }
      if (parseInt(endHourSelect.value, 10) <= minStart) {
        // Auto select first allowed end hour
        for (let i = 0; i < endHourSelect.options.length; i++) {
          if (!endHourSelect.options[i].disabled) {
            endHourSelect.value = endHourSelect.options[i].value;
            break;
          }
        }
      }
    }

    // Load calendar and set up realtime listener
    async function loadAndRenderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      // Load signups for month and render calendar after loading
      // But since we have realtime listener, no need to fetch once here
      // We'll just set listener, which triggers first load and update

      setupRealtimeListener(year, month);
    }

    // Initial setup
    setupHourSelects();
    loadAndRenderCalendar();
  </script>
</body>
</html>
