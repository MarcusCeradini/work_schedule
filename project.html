<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Schedule by Hour Ranges (Firebase)</title>
  <style>
    /* Your existing CSS styles here */
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      max-width: 700px;
      margin: auto;
      padding: 10px;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
      user-select: none;
    }
    .day {
      border: 1px solid #ccc;
      padding: 12px 8px;
      min-height: 90px;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      background-color: #fefefe;
      transition: background-color 0.3s;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    .day:hover {
      background-color: #e6f7ff;
    }
    .day.full {
      background-color: #ffd6d6;
      cursor: not-allowed;
    }
    .day .date-number {
      font-weight: bold;
      font-size: 1.3em;
      margin-bottom: 6px;
      user-select: none;
    }
    .signup-count {
      margin-top: 8px;
      font-size: 0.9em;
      color: #444;
    }
    .header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 18px;
      font-size: 1.1em;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #007bff;
      background: #007bff;
      color: white;
      transition: background-color 0.3s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    #monthYear {
      margin: 0 12px;
      font-size: 1.8em;
      user-select: none;
      white-space: nowrap;
    }
    /* Modal styles */
    #modal {
      display: none; /* hidden by default */
      position: fixed;
      top: 0; left: 0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      padding: 10px;
      z-index: 9999;
      -webkit-overflow-scrolling: touch;
    }
    #modalContent {
      background: white;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
      text-align: left;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-size: 16px;
    }
    #modalContent h3 {
      margin-top: 0;
      font-size: 1.4em;
      user-select: none;
    }
    .signup-entry {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 1em;
      background: #f0f8ff;
      word-break: break-word;
    }
    .signup-entry .time {
      font-weight: bold;
      margin-right: 10px;
    }
    form {
      margin-top: 15px;
      border-top: 1px solid #ccc;
      padding-top: 12px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 1em;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 14px;
      box-sizing: border-box;
      font-size: 1em;
      border: 1.5px solid #ccc;
      border-radius: 6px;
      outline-offset: 2px;
      -webkit-appearance: none;
      appearance: none;
    }
    #closeModalBtn {
      position: absolute;
      top: 10px;
      right: 14px;
      background: #eee;
      border: none;
      font-size: 1.8em;
      cursor: pointer;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      line-height: 34px;
      text-align: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background-color 0.2s;
    }
    #closeModalBtn:hover {
      background: #ccc;
    }
    .error {
      color: red;
      font-size: 0.95em;
      margin-bottom: 10px;
      min-height: 1.2em;
    }

    /* Responsive tweaks */
    @media (max-width: 600px) {
      .calendar {
        grid-template-columns: repeat(4, 1fr);
      }
      button {
        padding: 10px 14px;
        font-size: 1em;
      }
      #monthYear {
        font-size: 1.3em;
      }
      .day {
        min-height: 70px;
        font-size: 13px;
        padding: 10px 6px;
      }
    }
  </style>
</head>
<body>

  <h1>Schedule by Hour Ranges</h1>
  <div class="header">
    <button onclick="changeMonth(-1)" aria-label="Previous Month">&#8592; Prev</button>
    <h2 id="monthYear" aria-live="polite"></h2>
    <button onclick="changeMonth(1)" aria-label="Next Month">Next &#8594;</button>
  </div>

  <div class="calendar" id="calendar" role="list" aria-label="Calendar days"></div>

  <!-- Modal for signups -->
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalDateTitle" tabindex="-1">
    <div id="modalContent">
      <button id="closeModalBtn" title="Close">&times;</button>
      <h3 id="modalDateTitle"></h3>
      <div id="signupsList" tabindex="0" aria-live="polite">
        <!-- existing signups shown here -->
      </div>

      <form id="signupForm">
        <div class="error" id="errorMsg" aria-live="assertive"></div>
        <label for="nameInput">Your Name:</label>
        <input type="text" id="nameInput" required placeholder="Enter your name" autocomplete="name" />

        <label for="startHourSelect">Start Hour:</label>
        <select id="startHourSelect" required aria-describedby="startHourDesc"></select>

        <label for="endHourSelect">End Hour:</label>
        <select id="endHourSelect" required aria-describedby="endHourDesc"></select>

        <button type="submit">Sign Up</button>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const MAX_PEOPLE_AT_ONCE = 3; // max people allowed working simultaneously
    const DAILY_START = "09:00";
    const DAILY_END = "18:00";

    let currentDate = new Date();

    // Firebase config - replace this with YOUR config from Firebase Console
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Signups stored here in memory for current session, sync with Firebase
    let signups = {};

    function saveSignupsToFirebase() {
      db.ref('signups').set(signups);
    }

    function loadSignupsFromFirebase(callback) {
      db.ref('signups').on('value', (snapshot) => {
        signups = snapshot.val() || {};
        callback();
      });
    }

    function renderCalendar() {
      const calendar = document.getElementById('calendar');
      const monthYear = document.getElementById('monthYear');
      calendar.innerHTML = '';

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay(); // Sunday = 0

      monthYear.textContent = `${firstDay.toLocaleString('default', { month: 'long' })} ${year}`;

      // Fill empty cells for first week day offset
      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement('div');
        calendar.appendChild(empty);
      }

      const today = new Date();
      today.setHours(0,0,0,0); // clear time for date comparison

      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = formatDate(year, month + 1, day);
        const dayDate = new Date(year, month, day);
        dayDate.setHours(0,0,0,0);

        const dayDiv = document.createElement('div');
        dayDiv.classList.add('day');
        dayDiv.setAttribute('role', 'listitem');
        dayDiv.setAttribute('tabindex', '-1');

        const totalSignups = (signups[dateStr] || []).length;

        dayDiv.innerHTML = `<div class="date-number">${day}</div>
                            <div class="signup-count">${totalSignups} signed up</div>`;

        // Disable past days (not clickable)
        if (dayDate < today) {
          dayDiv.style.backgroundColor = '#f0f0f0';
          dayDiv.style.color = '#999';
          dayDiv.style.cursor = 'not-allowed';
          dayDiv.setAttribute('aria-disabled', 'true');
        } else {
          dayDiv.onclick = () => openModal(dateStr);
          dayDiv.setAttribute('tabindex', '0');
          dayDiv.setAttribute('aria-label', `Day ${day}, ${totalSignups} people signed up. Tap to sign up.`);
          dayDiv.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openModal(dateStr);
            }
          });
        }

        calendar.appendChild(dayDiv);
      }
    }

    function openModal(dateStr) {
      const modal = document.getElementById('modal');
      const modalDateTitle = document.getElementById('modalDateTitle');
      const signupsList = document.getElementById('signupsList');
      const signupForm = document.getElementById('signupForm');
      const errorMsg = document.getElementById('errorMsg');
      const startHourSelect = document.getElementById('startHourSelect');
      const endHourSelect = document.getElementById('endHourSelect');

      modalDateTitle.textContent = `Signups for ${dateStr}`;
      errorMsg.textContent = '';

      // Show existing signups
      signupsList.innerHTML = '';

      if (signups[dateStr] && signups[dateStr].length > 0) {
        signups[dateStr].forEach(entry => {
          const div = document.createElement('div');
          div.classList.add('signup-entry');
          div.innerHTML = `<span class="time">${entry.startTime} - ${entry.endTime}</span> <strong>${entry.name}</strong>`;
          signupsList.appendChild(div);
        });
      } else {
        signupsList.textContent = "No signups yet.";
      }

      // Reset form inputs
      signupForm.reset();

      // Populate start hour options
      startHourSelect.innerHTML = '';
      endHourSelect.innerHTML = '';

      const startHour = parseInt(DAILY_START.split(':')[0], 10);
      const endHour = parseInt(DAILY_END.split(':')[0], 10);

      for (let h = startHour; h < endHour; h++) {
        const option = document.createElement('option');
        option.value = `${String(h).padStart(2, '0')}:00`;
        option.textContent = `${String(h).padStart(2, '0')}:00`;
        startHourSelect.appendChild(option);
      }

      function updateEndHourOptions() {
        const selectedStart = parseInt(startHourSelect.value.split(':')[0], 10);
        endHourSelect.innerHTML = '';
        for (let h = selectedStart + 1; h <= endHour; h++) {
          const option = document.createElement('option');
          option.value = `${String(h).padStart(2, '0')}:00`;
          option.textContent = `${String(h).padStart(2, '0')}:00`;
          endHourSelect.appendChild(option);
        }
      }

      startHourSelect.addEventListener('change', updateEndHourOptions);
      updateEndHourOptions();

      modal.style.display = 'flex';
      modal.focus();

      // Form submission handler
      signupForm.onsubmit = (e) => {
        e.preventDefault();
        errorMsg.textContent = '';

        const name = document.getElementById('nameInput').value.trim();
        const startTime = startHourSelect.value;
        const endTime = endHourSelect.value;

        if (!name) {
          errorMsg.textContent = "Name is required.";
          return;
        }

        if (startTime >= endTime) {
          errorMsg.textContent = "End hour must be later than start hour.";
          return;
        }

        // Check max simultaneous people constraint
        if (!canAddSignup(dateStr, startTime, endTime)) {
          errorMsg.textContent = `Maximum ${MAX_PEOPLE_AT_ONCE} people allowed simultaneously in overlapping time ranges.`;
          return;
        }

        addSignup(dateStr, { name, startTime, endTime });
        saveSignupsToFirebase();

        // Close modal and refresh calendar
        modal.style.display = 'none';
        renderCalendar();
      };
    }

    function canAddSignup(dateStr, startTime, endTime) {
      const entries = signups[dateStr] || [];
      const [newStartH, newStartM] = startTime.split(':').map(Number);
      const [newEndH, newEndM] = endTime.split(':').map(Number);
      const newStart = newStartH * 60 + newStartM;
      const newEnd = newEndH * 60 + newEndM;

      // Check overlapping counts for each minute of new signup
      // Optimize by checking overlapping intervals instead of every minute
      // But since max 3 people and small dataset, a simple approach is fine

      // Collect time points (start/end) from existing signups and the new one
      let overlaps = 0;

      for (let m = newStart; m < newEnd; m++) {
        // Count how many existing signups overlap minute m
        let count = 0;
        for (const entry of entries) {
          const [startH, startM] = entry.startTime.split(':').map(Number);
          const [endH, endM] = entry.endTime.split(':').map(Number);
          const start = startH * 60 + startM;
          const end = endH * 60 + endM;
          if (m >= start && m < end) {
            count++;
          }
        }
        if (count >= MAX_PEOPLE_AT_ONCE) {
          return false; // reached max for this minute
        }
      }
      return true;
    }

    function addSignup(dateStr, entry) {
      if (!signups[dateStr]) signups[dateStr] = [];
      signups[dateStr].push(entry);
    }

    function formatDate(year, month, day) {
      return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }

    function changeMonth(delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      renderCalendar();
    }

    // Close modal handlers
    document.getElementById('closeModalBtn').onclick = () => {
      document.getElementById('modal').style.display = 'none';
    };

    // Close modal if user clicks outside modalContent
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        e.currentTarget.style.display = 'none';
      }
    });

    // Keyboard accessibility for modal: Escape key closes modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('modal');
        if (modal.style.display === 'flex') {
          modal.style.display = 'none';
        }
      }
    });

    // On page load, get signups from Firebase, then render calendar
    loadSignupsFromFirebase(renderCalendar);
  </script>

</body>
</html>
